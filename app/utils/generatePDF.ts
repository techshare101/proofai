import { PDFDocument, StandardFonts, rgb } from 'pdf-lib';
import QRCode from 'qrcode';

export async function generatePDF(structuredSummary: {
  caseId: string;
  location?: string;
  participants?: string[];
  relevance?: string;
  summaryText?: string;
  transcriptText?: string;
  timestamp?: string;
  userId?: string;
  generatedBy?: string;
}) {
  console.log('✅ NEW PDF GENERATOR LOADED', { 
    summaryAvailable: !!structuredSummary.summaryText, 
    transcriptAvailable: !!structuredSummary.transcriptText 
  });
  const {
    caseId,
    location = 'Unknown Location',
    participants,
    relevance,
    summaryText,
    transcriptText,
    timestamp = new Date().toISOString(),
    userId = 'Unknown',
    generatedBy = 'ProofAI Whisper Bot',
  } = structuredSummary;

  const pdfDoc = await PDFDocument.create();
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const boldFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
  const pageWidth = 612;
  const margin = 50;

  const addFooter = (page: any, pageNum: number, totalPages: number) => {
    const footerText = `Page ${pageNum} of ${totalPages}`;
    const footerNote = 'Generated by ProofAI • www.proof.ai • This document is timestamped and immutable.';
    page.drawText(footerText, {
      x: pageWidth / 2 - 30, // Center the page number
      y: 30,
      size: 10,
      font,
    });
    page.drawText(footerNote, {
      x: pageWidth / 2 - 150, // Center the footer note
      y: 15,
      size: 10,
      font,
    });
  };

  // Check if we need to create a fallback/empty state PDF
  const hasFullContent = summaryText && transcriptText;
  
  // Create a single page for fallback or multiple pages for full content
  const page1 = pdfDoc.addPage();
  page1.setFont(boldFont);
  
  if (hasFullContent) {
    // FULL CONTENT FORMAT - PAGE 1: CASE REPORT / SUMMARY
    
    // Main header
    page1.drawText('CASE REPORT', { x: margin, y: 750, size: 14, font: boldFont });
    
    // Location in black
    page1.setFont(font);
    page1.drawText(`Location: ${location}`, { x: margin, y: 725, size: 12, font });
    
    // REPORT SUMMARY section header
    page1.drawText('REPORT SUMMARY', { x: margin, y: 685, size: 14, font: boldFont });
    
    // Draw dashed line under REPORT SUMMARY
    page1.drawLine({
      start: { x: margin, y: 680 },
      end: { x: margin + 200, y: 680 },
      thickness: 1,
      color: rgb(0.7, 0.7, 0.7), // Light gray
      dashArray: [3, 3], // Creates a dashed line
    });
    
    // Case ID in purple (as shown in the image)
    page1.drawText('Case ID:', { x: margin, y: 660, size: 12, color: rgb(0.4, 0, 0.6), font }); // Purple color
    page1.drawText(caseId, { 
      x: margin + 60, 
      y: 660, 
      size: 12, 
      color: rgb(0.6, 0, 0), // Dark red/burgundy
      font: boldFont
    });
    
    // Report Date
    const formattedDate = new Date(timestamp).toLocaleString();
    page1.drawText('Report Date:', { x: margin, y: 640, size: 12, color: rgb(0.4, 0, 0.6), font }); // Purple color
    page1.drawText(formattedDate, { x: margin + 85, y: 640, size: 12, color: rgb(0, 0, 0), font });
    
    // Location with brown color (as shown in the image)
    page1.drawText('Location:', { x: margin, y: 620, size: 12, color: rgb(0.4, 0, 0.6), font }); // Purple color
    page1.drawText(location, { 
      x: margin + 70, 
      y: 620, 
      size: 12, 
      color: rgb(0.6, 0.4, 0.2), // Brown color
      font 
    });
    
    // Participants 
    page1.drawText('Participants:', { x: margin, y: 600, size: 12, color: rgb(0.4, 0, 0.6), font }); // Purple color
    page1.drawText(participants?.length ? participants.join(', ') : 'None listed', { 
      x: margin + 85, 
      y: 600, 
      size: 12, 
      color: rgb(0, 0, 0), 
      font 
    });
    
    // Relevance
    page1.drawText('Relevance:', { x: margin, y: 580, size: 12, color: rgb(0.4, 0, 0.6), font }); // Purple color
    page1.drawText(relevance || 'NOT SPECIFIED', { 
      x: margin + 80, 
      y: 580, 
      size: 12, 
      color: rgb(0, 0, 0), 
      font 
    });
    
    // Section divider
    page1.drawLine({
      start: { x: margin, y: 560 },
      end: { x: pageWidth - margin, y: 560 },
      thickness: 1,
      color: rgb(0.7, 0.7, 0.7), // Light gray
    });
    
    // ENGLISH TRANSLATION header
    page1.drawText('ENGLISH TRANSLATION', { x: margin, y: 540, size: 14, font: boldFont });
    
    // Summary text with proper line height and margins
    page1.drawText(summaryText.slice(0, 2000), { 
      x: margin, 
      y: 520, 
      size: 11, 
      font, 
      lineHeight: 14, 
      maxWidth: pageWidth - (2 * margin) 
    });
    
    addFooter(page1, 1, 2);
    
    // PAGE 2: TRANSCRIPT + QR + SIGNATURE
    const page2 = pdfDoc.addPage();
    
    // ORIGINAL TRANSCRIPT header
    page2.setFont(boldFont);
    page2.drawText('ORIGINAL TRANSCRIPT (es)', { x: margin, y: 750, size: 14, font: boldFont });
    
    // Transcript text
    page2.setFont(font);
    page2.drawText(transcriptText.slice(0, 2000), { 
      x: margin, 
      y: 730, 
      size: 11, 
      font, 
      lineHeight: 14, 
      maxWidth: pageWidth - (2 * margin) 
    });
    
    // Create green rectangle for QR code background
    page2.drawRectangle({
      x: margin,
      y: 140,
      width: pageWidth - (2 * margin),
      height: 200,
      color: rgb(0.13, 0.69, 0.42), // Green color matching screenshot
    });
    
    // QR CODE HEADING (white text on green background)
    page2.drawText('SCAN TO WATCH EVIDENCE', { 
      x: margin + 70, 
      y: 300, 
      size: 16, 
      font: boldFont,
      color: rgb(1, 1, 1), // White
    });
    
    // URL text in white
    page2.drawText(`Or visit: proof.ai/case/${caseId}`, { 
      x: margin + 70, 
      y: 275, 
      size: 12, 
      font,
      color: rgb(1, 1, 1), // White
    });
    
    // Generate QR Code
    const qrDataUrl = await QRCode.toDataURL(`https://proof.ai/case/${caseId}`);
    const qrImageBytes = await fetch(qrDataUrl).then((res) => res.arrayBuffer());
    const qrImage = await pdfDoc.embedPng(qrImageBytes);
    
    // Place QR code in the green rectangle
    page2.drawImage(qrImage, { 
      x: margin + (pageWidth - (2 * margin) - 170) / 2, // Center in the green box
      y: 150, 
      width: 170, 
      height: 170 
    });
    
    // Signature line and text
    page2.drawLine({
      start: { x: margin, y: 110 },
      end: { x: margin + 200, y: 110 },
      thickness: 1,
      color: rgb(0, 0, 0),
    });
    page2.drawText('Authorized Signature', { x: margin, y: 100, size: 10, font });
    
    addFooter(page2, 2, 2);
  } else {
    // FALLBACK FORMAT - Single page with basic info and fallback message
    // Based on the screenshot provided by the user
    
    // Title
    page1.drawText('ProofAI Evidence Report', { x: margin + 25, y: 750, size: 24, font: boldFont });
    
    // Basic case information
    page1.setFont(font);
    let y = 700;
    
    page1.drawText(`Case ID: ${caseId}`, { x: margin + 25, y, size: 14, font: boldFont });
    y -= 25;
    
    page1.drawText(`Generated by: ${generatedBy}`, { x: margin + 25, y, size: 14, font });
    y -= 25;
    
    const dateFormatted = new Date(timestamp).toLocaleDateString();
    page1.drawText(`Date: ${dateFormatted}`, { x: margin + 25, y, size: 14, font });
    y -= 25;
    
    page1.drawText(`User ID: ${userId}`, { x: margin + 25, y, size: 14, font });
    y -= 45;
    
    // Content section with fallback message
    page1.drawText('Content:', { x: margin + 25, y, size: 18, font: boldFont });
    y -= 30;
    
    page1.drawText('Summary not available. Please re-upload your recording.', { 
      x: margin + 25, 
      y, 
      size: 14, 
      font,
      color: rgb(0.5, 0, 0) // Dark red for warning
    });
    
    addFooter(page1, 1, 1);
  }
  // No additional code needed here - everything is handled in the conditional branches above
  
  const pdfBytes = await pdfDoc.save();
  return pdfBytes;
}
